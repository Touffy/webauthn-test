<html>

<head>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.3.0/milligram.css">
  <link rel="stylesheet" href="style.css">
  <script src="lib.js" async></script>
</head>

<body>
  <h1>Web Authn</h1>
  <form>
      <label>username: <input type="text" name="username" placeholder="jeancloud" required></label>
      <label>display name: <input type="text" name="fullname" placeholder="Jean-Cloud" required></label>
      <div>
        <button>Register</button>
        <a href="login.html">Go login page</a>
      </div>
  </form>
  <script>
    var token
    // REGISTER
    document.forms[0].onsubmit = function (e) {
      e.preventDefault()
      var body = JSON.stringify({
        username: this.username.value,
        fullname: this.fullname.value
      })
      fetch("/register", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body
      })
      .then((response) => response.json())
      .then((body) => {
        body.challenge.challenge = Uint8Array.from(base64decode(body.challenge.challenge), c => c.charCodeAt(0))
        body.challenge.user.id = Uint8Array.from(base64decode(body.challenge.user.id), c => c.charCodeAt(0))
        token = body.token
        return body
      })
      .then(({ challenge }) => {
        return navigator.credentials.create({ publicKey: challenge })
      })
      .then((creds) => {
        return publicKeyCredentialToJSON(creds)
      })
      .then((jsonCreds) => {
        const body = JSON.stringify(jsonCreds)

        return fetch("/register/response", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body
        })
      })
      .then((response) => response.json())
      .then((body) => {
	      if (body.status === "registered") alert("ðŸ¤™ Yeah, you're registered")
      })

      .catch(console.error)
    };
  </script>
</body>

</html>
